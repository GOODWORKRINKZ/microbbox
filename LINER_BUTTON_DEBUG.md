# Отладка кнопки автономного режима для MicroBox Liner

## Проблема
Кнопка не реагирует на нажатия, в логах не видно сообщений о переходе в режим автоследования по линии.

## Исправления
1. Упрощена логика обработки кнопки - убрана сложная инициализация
2. Добавлена подробная диагностика для отладки
3. Исправлено количество светодиодов: 16 для Liner (8 на каждую сторону)

## Как проверить работу кнопки

### Шаг 1: Подключение и запуск
1. Подключите робота к компьютеру через USB
2. Откройте Serial Monitor на скорости **115200 baud**
3. Перезагрузите робота (кнопка RESET или переподключите USB)

### Шаг 2: Проверка инициализации
При запуске вы должны увидеть:
```
═══════════════════════════════════════
  МикРоББокс запускается...
  Тип: MicroBox-Liner
═══════════════════════════════════════
...
=== Инициализация компонентов Liner робота ===
FEATURE_BUTTON определен, инициализируем кнопку...
Инициализация кнопки...
Кнопка на пине 4, начальное состояние: HIGH (не нажата)
Кнопка настроена с INPUT_PULLUP, нажатие = LOW (замыкание на GND)
Кнопка инициализирована
✓ Кнопка успешно инициализирована!
```

**❌ Если видите "FEATURE_BUTTON НЕ определен":**
- Вы собрали неправильную конфигурацию
- Нужно собрать `liner-debug` или `liner-release`:
  ```bash
  platformio run -e liner-debug
  platformio upload -e liner-debug
  ```

### Шаг 3: Проверка диагностики во время работы

Каждые **2 секунды** выводится состояние кнопки:
```
[BUTTON_DIAG] Pin 4 = 1 (HIGH/не_нажата), buttonPressed_ = false
```

Каждые **5 секунд** выводится текущий режим:
```
[MODE_DIAG] Текущий режим: РУЧНОЙ
```

### Шаг 4: Тест нажатия кнопки

1. Нажмите кнопку и держите **1-2 секунды**
2. Вы должны увидеть:
```
[BUTTON_DIAG] Pin 4 = 0 (LOW/нажата), buttonPressed_ = false
Кнопка: переход в НАЖАТО, вызов onButtonPressed()
==================================================
КНОПКА НАЖАТА!
Текущий режим: РУЧНОЙ
>>> ПЕРЕХОД В АВТОНОМНЫЙ РЕЖИМ <<<
>>> НАЧАТО АВТОСЛЕДОВАНИЕ ПО ЛИНИИ <<<
PID контроллер сброшен
==================================================
```

3. Отпустите кнопку:
```
Кнопка: переход в ОТПУЩЕНО
```

4. Через несколько секунд должно появиться:
```
[MODE_DIAG] Текущий режим: АВТОНОМНЫЙ (следование по линии)
```

5. Светодиоды должны изменить цвет:
   - **Синий** = Ручной режим
   - **Зеленый** = Автономный режим

### Шаг 5: Повторное нажатие (возврат в ручной режим)

Нажмите кнопку еще раз:
```
==================================================
КНОПКА НАЖАТА!
Текущий режим: АВТОНОМНЫЙ
>>> ПЕРЕХОД В РУЧНОЙ РЕЖИМ <<<
>>> АВТОСЛЕДОВАНИЕ ОСТАНОВЛЕНО <<<
Моторы остановлены
==================================================
```

## Возможные проблемы

### 1. Кнопка всегда показывает LOW
```
[BUTTON_DIAG] Pin 4 = 0 (LOW/нажата), buttonPressed_ = true
```
**Причины:**
- Короткое замыкание на пине 4
- Кнопка припаяна неправильно (должна быть между GPIO4 и GND)
- Кнопка застряла в нажатом состоянии

**Решение:**
- Проверьте пайку кнопки
- Убедитесь что кнопка подключена между GPIO4 и GND (не к VCC!)
- Отпаяйте кнопку и проверьте её отдельно

### 2. Не видно диагностических сообщений
**Причины:**
- Неправильная скорость Serial (должна быть 115200)
- Собрана release конфигурация без DEBUG

**Решение:**
```bash
# Соберите debug конфигурацию
platformio run -e liner-debug
platformio upload -e liner-debug

# Откройте Serial Monitor
platformio device monitor -b 115200
```

### 3. Кнопка не реагирует, но показывает HIGH
```
[BUTTON_DIAG] Pin 4 = 1 (HIGH/не_нажата), buttonPressed_ = false
```
После нажатия ничего не меняется.

**Причины:**
- Кнопка не подключена
- Плохой контакт
- Кнопка подключена к неправильному пину

**Решение:**
- Проверьте что кнопка подключена к GPIO4 (не к другому пину!)
- Проверьте качество пайки
- Попробуйте замкнуть GPIO4 на GND напрямую проводом - если работает, проблема в кнопке

### 4. Видите "FEATURE_BUTTON НЕ определен"
**Причина:**
- Собрана неправильная конфигурация (classic или brain)

**Решение:**
```bash
# Проверьте что собираете liner конфигурацию
platformio run -e liner-debug --verbose

# В выводе должно быть: -D TARGET_LINER
```

## Схема подключения кнопки

```
        3.3V
         |
        [10kΩ]  (внутренний pull-up резистор в ESP32)
         |
    GPIO4 ●-----[Кнопка]-----● GND
```

При нажатии кнопки GPIO4 замыкается на GND → LOW (логический 0)
При отпускании кнопки GPIO4 подтянут к 3.3V → HIGH (логическая 1)

## Технические детали

- **Пин кнопки:** GPIO4 (BUTTON_PIN в hardware_config.h)
- **Режим пина:** INPUT_PULLUP (встроенный подтягивающий резистор)
- **Логика:** Активный LOW (нажата = LOW/0, не нажата = HIGH/1)
- **Антидребезг:** 50 мс (BUTTON_DEBOUNCE_MS)
- **Частота проверки:** Каждые 50 мс + антидребезг

## Дополнительная информация

Если после всех проверок кнопка не работает:
1. Создайте issue на GitHub с полным логом Serial Monitor
2. Укажите как припаяна кнопка (с фото если возможно)
3. Укажите модель ESP32CAM и версию прошивки
