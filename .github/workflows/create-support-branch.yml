name: Create Support Branch

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ support/X.Y.x Ð²ÐµÑ‚ÐºÑƒ Ð¿Ñ€Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð°
# ÐŸÑ€Ð¸Ð¼ÐµÑ€: Ñ€ÐµÐ»Ð¸Ð· v0.1.0 â†’ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ support/0.1.x

on:
  release:
    types: [published]

permissions:
  contents: write
  issues: write

jobs:
  create-support-branch:
    name: Create Support Branch
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Extract Version
      id: version
      run: |
        TAG_NAME="${{ github.event.release.tag_name }}"
        # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ 'v' Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
        VERSION=${TAG_NAME#v}
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ major.minor
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f2)
        
        SUPPORT_BRANCH="support/${MAJOR}.${MINOR}.x"
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "support_branch=${SUPPORT_BRANCH}" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¦ Ð ÐµÐ»Ð¸Ð·: ${TAG_NAME}"
        echo "ðŸŒ¿ Support Ð²ÐµÑ‚ÐºÐ°: ${SUPPORT_BRANCH}"
        
    - name: Check if Support Branch Exists
      id: check
      run: |
        BRANCH="${{ steps.version.outputs.support_branch }}"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
        if git show-ref --verify --quiet refs/heads/${BRANCH}; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  Ð’ÐµÑ‚ÐºÐ° ${BRANCH} ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾"
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ remote
        elif git ls-remote --heads origin ${BRANCH} | grep -q ${BRANCH}; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  Ð’ÐµÑ‚ÐºÐ° ${BRANCH} ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð½Ð° remote"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "âœ… Ð’ÐµÑ‚ÐºÐ° ${BRANCH} Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ - ÑÐ¾Ð·Ð´Ð°ÐµÐ¼"
        fi
        
    - name: Create Support Branch
      if: steps.check.outputs.exists == 'false'
      run: |
        BRANCH="${{ steps.version.outputs.support_branch }}"
        TAG="${{ github.event.release.tag_name }}"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²ÐµÑ‚ÐºÑƒ Ð¾Ñ‚ Ñ‚ÐµÐ³Ð° Ñ€ÐµÐ»Ð¸Ð·Ð°
        git checkout -b ${BRANCH} ${TAG}
        git push origin ${BRANCH}
        
        echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° support Ð²ÐµÑ‚ÐºÐ°: ${BRANCH}"
        
    - name: Create Tracking Issue
      if: steps.check.outputs.exists == 'false'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.ADMIN_TOKEN }}
        script: |
          const version = '${{ steps.version.outputs.version }}';
          const supportBranch = '${{ steps.version.outputs.support_branch }}';
          const tagName = '${{ github.event.release.tag_name }}';
          
          // Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ EOL Ð´Ð°Ñ‚Ñƒ (6 Ð¼ÐµÑÑÑ†ÐµÐ² Ð¿Ð¾ÑÐ»Ðµ Ñ€ÐµÐ»Ð¸Ð·Ð°)
          const releaseDate = new Date();
          const eolDate = new Date(releaseDate);
          eolDate.setMonth(eolDate.getMonth() + 6);
          
          const eolNotifyDate = new Date(eolDate.getTime() - 30*24*60*60*1000).toISOString().split('T')[0];
          
          const issueBody = `# Support Branch Created: ${supportBranch}\n\n` +
            `## Release Information\n\n` +
            `- **Version**: ${version}\n` +
            `- **Release Tag**: ${tagName}\n` +
            `- **Release Date**: ${releaseDate.toISOString().split('T')[0]}\n` +
            `- **EOL Date**: ${eolDate.toISOString().split('T')[0]} (6 months from release)\n` +
            `- **Support Branch**: \`${supportBranch}\`\n` +
            `- **Release URL**: ${context.payload.release.html_url}\n\n` +
            `## Support Status\n\n` +
            `- [x] Support branch created\n` +
            `- [ ] Branch protection enabled\n` +
            `- [ ] Documentation updated\n` +
            `- [ ] First maintenance release planned\n\n` +
            `## Maintenance Schedule\n\n` +
            `| Task | Status | Target Date |\n` +
            `|------|--------|-------------|\n` +
            `| Branch created | âœ… Done | ${releaseDate.toISOString().split('T')[0]} |\n` +
            `| First patch release | â³ Pending | TBD |\n` +
            `| EOL notification | â³ Scheduled | ${eolNotifyDate} |\n` +
            `| Version EOL | â³ Scheduled | ${eolDate.toISOString().split('T')[0]} |\n\n` +
            `## Next Steps\n\n` +
            `1. Enable branch protection rules for \`${supportBranch}\`\n` +
            `2. Update \`SUPPORT_STATUS.md\` with new version\n` +
            `3. Plan maintenance releases if needed\n` +
            `4. Monitor for critical bugs requiring backport\n\n` +
            `---\n\n` +
            `This issue tracks the support lifecycle for version ${version}.\n` +
            `It will be updated with maintenance releases and backported fixes.\n\n` +
            `**Auto-created by create-support-branch workflow**`;
          
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `[Support] Version ${version} Support Tracking`,
            body: issueBody,
            labels: ['support', 'tracking', `version-${version}`]
          });
          
          core.info(`âœ… Created tracking issue: #${issue.data.number}`);
          
    - name: Summary
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        BRANCH="${{ steps.version.outputs.support_branch }}"
        TAG="${{ github.event.release.tag_name }}"
        
        echo "## âœ… Support Branch Management" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release**: ${TAG}" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check.outputs.exists }}" == "true" ]; then
          echo "âš ï¸  Support branch \`${BRANCH}\` already exists" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… Created support branch: \`${BRANCH}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Branch protection will be configured automatically" >> $GITHUB_STEP_SUMMARY
          echo "- Tracking issue created for this version" >> $GITHUB_STEP_SUMMARY
          echo "- EOL scheduled for 6 months from now" >> $GITHUB_STEP_SUMMARY
        fi
