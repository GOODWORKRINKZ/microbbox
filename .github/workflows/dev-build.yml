name: ÐœÐ¸ÐºÐ Ð¾Ð‘Ð‘Ð¾ÐºÑ Dev Build

# Workflow Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ Ð¸Ð· develop Ð¸ feature Ð²ÐµÑ‚Ð¾Ðº
# Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¸ Ð¿Ñ€Ð¾ÑˆÐ¸Ñ‚ÑŒ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
# Ð¢Ð°ÐºÐ¶Ðµ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ draft releases Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ð³Ð¾ OTA Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ

on:
  push:
    branches:
      - develop
      - 'feature/**'
  workflow_dispatch:
    inputs:
      create_draft_release:
        description: 'Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ draft release Ð´Ð»Ñ OTA'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-dev-firmware:
    name: Build Developer Firmware
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get Branch Info
      id: branch_info
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        BRANCH_NAME_SAFE=$(echo "$BRANCH_NAME" | sed 's/[\/]/-/g')
        SHORT_SHA=$(git rev-parse --short HEAD)
        BUILD_DATE=$(date -u +'%Y%m%d-%H%M%S')
        
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð´Ð»Ñ dev ÑÐ±Ð¾Ñ€ÐºÐ¸
        # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: branch-name-shortsha-date
        DEV_VERSION="${BRANCH_NAME_SAFE}-${SHORT_SHA}-${BUILD_DATE}"
        
        echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        echo "branch_name_safe=${BRANCH_NAME_SAFE}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
        echo "dev_version=${DEV_VERSION}" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¦ Building dev firmware for branch: ${BRANCH_NAME}"
        echo "ðŸ”– Dev version: ${DEV_VERSION}"
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
          
    - name: Install PlatformIO and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install platformio htmlmin jsmin csscompressor
        
    - name: Build All Robot Types (Release)
      run: |
        echo "ðŸ”¨ Building all robot types (release)..."
        pio run --environment classic-release --environment liner-release --environment brain-release
        
    - name: Prepare Dev Firmware Files
      run: |
        DEV_VERSION="${{ steps.branch_info.outputs.dev_version }}"
        BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
        SHORT_SHA="${{ steps.branch_info.outputs.short_sha }}"
        
        echo "ðŸ“¦ Preparing dev firmware files..."
        
        # Array of robot types
        ROBOT_TYPES=("classic" "liner" "brain")
        
        # Copy and rename firmware files
        for robot in "${ROBOT_TYPES[@]}"; do
          BUILD_DIR=".pio/build/${robot}-release"
          OUTPUT_NAME="microbox-${robot}-dev-${DEV_VERSION}.bin"
          
          if [ ! -f "${BUILD_DIR}/firmware.bin" ]; then
            echo "ERROR: ${BUILD_DIR}/firmware.bin not found!"
            exit 1
          fi
          
          cp "${BUILD_DIR}/firmware.bin" "${OUTPUT_NAME}"
          echo "âœ… Created: ${OUTPUT_NAME}"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒÐ½ÑƒÑŽ ÑÑƒÐ¼Ð¼Ñƒ
          sha256sum "${OUTPUT_NAME}" > "${OUTPUT_NAME}.sha256"
          
          # Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ
          SIZE=$(stat -c%s "${OUTPUT_NAME}")
          echo "   Size: $(($SIZE / 1024)) KB"
        done
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
        cat > DEV_BUILD_INFO.txt << EOF
        ÐœÐ¸ÐºÐ Ð¾Ð‘Ð‘Ð¾ÐºÑ Developer Build
        
        Branch: ${BRANCH_NAME}
        Commit: ${SHORT_SHA}
        Build Date: ${{ steps.branch_info.outputs.build_date }}
        Dev Version: ${DEV_VERSION}
        
        Built from: https://github.com/${{ github.repository }}/tree/${SHORT_SHA}
        
        Robot Types:
        - Classic (ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼Ñ‹Ð¹ Ñ€Ð¾Ð±Ð¾Ñ‚)
        - Liner (ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾ Ð»Ð¸Ð½Ð¸Ð¸)
        - Brain (Ð¼Ð¾Ð´ÑƒÐ»ÑŒ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ)
        
        Ð­Ñ‚Ð¾ development ÑÐ±Ð¾Ñ€ÐºÐ° Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.
        ÐÐµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ production Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ.
        EOF
        
        echo "ðŸ“‹ Build info created"
        cat DEV_BUILD_INFO.txt
        
    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: microbbox-dev-${{ steps.branch_info.outputs.dev_version }}
        path: |
          microbox-*.bin
          microbox-*.sha256
          DEV_BUILD_INFO.txt
        retention-days: 30
        
    - name: Create Draft Release for OTA (Optional)
      if: |
        github.event.inputs.create_draft_release == 'true' || 
        github.ref == 'refs/heads/develop'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: dev-${{ steps.branch_info.outputs.dev_version }}
        name: ðŸ”§ Dev Build - ${{ steps.branch_info.outputs.branch_name_safe }}
        body: |
          # Developer Build - ${{ steps.branch_info.outputs.branch_name }}
          
          âš ï¸ **Ð­Ñ‚Ð¾ development ÑÐ±Ð¾Ñ€ÐºÐ° Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ!**
          
          **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ:**
          - Ð’ÐµÑ‚ÐºÐ°: `${{ steps.branch_info.outputs.branch_name }}`
          - Commit: `${{ steps.branch_info.outputs.short_sha }}`
          - Ð”Ð°Ñ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸: `${{ steps.branch_info.outputs.build_date }}`
          
          **ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:**
          1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð½ÑƒÐ¶Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ñ‚Ð¸Ð¿Ð° Ñ€Ð¾Ð±Ð¾Ñ‚Ð°
          2. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð¸Ð»Ð¸ esptool
          3. Ð¡Ð¾Ð¾Ð±Ñ‰Ð¸Ñ‚Ðµ Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ñ… Ð² Issues
          
          **Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸:**
          - `microbox-classic-dev-*.bin` - Ð´Ð»Ñ Classic Ñ€Ð¾Ð±Ð¾Ñ‚Ð°
          - `microbox-liner-dev-*.bin` - Ð´Ð»Ñ Liner Ñ€Ð¾Ð±Ð¾Ñ‚Ð°
          - `microbox-brain-dev-*.bin` - Ð´Ð»Ñ Brain Ñ€Ð¾Ð±Ð¾Ñ‚Ð°
          
          ---
          
          Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
        files: |
          microbox-*.bin
          microbox-*.sha256
          DEV_BUILD_INFO.txt
        draft: true
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Summary
      run: |
        echo "## âœ… Dev firmware built successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Build Information:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ steps.branch_info.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ steps.branch_info.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Dev Version**: ${{ steps.branch_info.outputs.dev_version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Firmware Files:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        ls -lh microbox-*.bin | awk '{print "- **" $9 "** - " $5}' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Firmware files uploaded as workflow artifacts." >> $GITHUB_STEP_SUMMARY
        echo "Go to Actions â†’ This workflow run â†’ Artifacts section" >> $GITHUB_STEP_SUMMARY
