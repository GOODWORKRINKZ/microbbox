name: Backport Hotfix

# –†—É—á–Ω–æ–π workflow –¥–ª—è backport hotfix'–æ–≤ –≤ support –≤–µ—Ç–∫–∏
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   1. Actions ‚Üí Backport Hotfix
#   2. –£–∫–∞–∂–∏—Ç–µ commit SHA
#   3. –í—ã–±–µ—Ä–∏—Ç–µ target version
#   4. Run workflow

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA –¥–ª—è backport (–ø–æ–ª–Ω—ã–π –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–π)'
        required: true
        type: string
      target_version:
        description: '–¶–µ–ª–µ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è backport'
        required: true
        type: choice
        options:
          - '0.0.x'
          - '0.1.x'
          - '0.2.x'
          - '1.0.x'
      pr_title:
        description: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ PR (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  backport:
    name: Backport to ${{ inputs.target_version }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: support/${{ inputs.target_version }}
        
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Validate Commit
      id: validate
      run: |
        COMMIT="${{ inputs.commit_sha }}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–º–º–∏—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if ! git cat-file -e ${COMMIT}^{commit} 2>/dev/null; then
          echo "‚ùå –ö–æ–º–º–∏—Ç ${COMMIT} –Ω–µ –Ω–∞–π–¥–µ–Ω"
          exit 1
        fi
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π SHA
        FULL_SHA=$(git rev-parse ${COMMIT})
        echo "full_sha=${FULL_SHA}" >> $GITHUB_OUTPUT
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–º–∏—Ç–µ
        COMMIT_MSG=$(git log -1 --pretty=%B ${FULL_SHA})
        COMMIT_AUTHOR=$(git log -1 --pretty=%an ${FULL_SHA})
        COMMIT_DATE=$(git log -1 --pretty=%ad --date=short ${FULL_SHA})
        
        echo "message<<EOF" >> $GITHUB_OUTPUT
        echo "${COMMIT_MSG}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "author=${COMMIT_AUTHOR}" >> $GITHUB_OUTPUT
        echo "date=${COMMIT_DATE}" >> $GITHUB_OUTPUT
        
        echo "‚úÖ –ö–æ–º–º–∏—Ç –≤–∞–ª–∏–¥–µ–Ω: ${FULL_SHA}"
        echo "üìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${COMMIT_MSG}"
        echo "üë§ –ê–≤—Ç–æ—Ä: ${COMMIT_AUTHOR}"
        
    - name: Create Backport Branch
      id: branch
      run: |
        TARGET_VERSION="${{ inputs.target_version }}"
        COMMIT_SHORT="${{ steps.validate.outputs.full_sha }}"
        COMMIT_SHORT="${COMMIT_SHORT:0:7}"
        
        BRANCH_NAME="backport/${TARGET_VERSION}/${COMMIT_SHORT}"
        
        echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
        
        git checkout -b ${BRANCH_NAME}
        
        echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ –≤–µ—Ç–∫–∞: ${BRANCH_NAME}"
        
    - name: Cherry-pick Commit
      id: cherrypick
      continue-on-error: true
      run: |
        COMMIT="${{ steps.validate.outputs.full_sha }}"
        
        echo "üçí Cherry-picking ${COMMIT}..."
        
        if git cherry-pick ${COMMIT}; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Cherry-pick —É—Å–ø–µ—à–µ–Ω"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ùå Cherry-pick –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
          git status --short | grep '^UU' > conflicts.txt || true
          
          # –ü—Ä–µ—Ä—ã–≤–∞–µ–º cherry-pick
          git cherry-pick --abort
        fi
        
    - name: Push Branch (if successful)
      if: steps.cherrypick.outputs.success == 'true'
      run: |
        BRANCH="${{ steps.branch.outputs.branch_name }}"
        
        git push origin ${BRANCH}
        
        echo "‚úÖ –í–µ—Ç–∫–∞ ${BRANCH} –∑–∞–ø—É—à–µ–Ω–∞"
        
    - name: Create Pull Request (if successful)
      if: steps.cherrypick.outputs.success == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const targetVersion = '${{ inputs.target_version }}';
          const commitSha = '${{ steps.validate.outputs.full_sha }}';
          const commitShort = commitSha.substring(0, 7);
          const commitMsg = `${{ steps.validate.outputs.message }}`;
          const commitAuthor = '${{ steps.validate.outputs.author }}';
          const commitDate = '${{ steps.validate.outputs.date }}';
          const branchName = '${{ steps.branch.outputs.branch_name }}';
          
          const customTitle = '${{ inputs.pr_title }}';
          const prTitle = customTitle || `[Backport ${targetVersion}] ${commitMsg.split('\n')[0]}`;
          
          const prBody = `# Backport to ${targetVersion}\n\n` +
            `## Original Commit\n\n` +
            `- **SHA**: ${commitSha}\n` +
            `- **Author**: ${commitAuthor}\n` +
            `- **Date**: ${commitDate}\n` +
            `- **Message**: \n` +
            `  \`\`\`\n` +
            `  ${commitMsg}\n` +
            `  \`\`\`\n\n` +
            `## Changes\n\n` +
            `This PR backports the fix from commit ${commitShort} to the \`support/${targetVersion}\` branch.\n\n` +
            `### Cherry-pick Status\n\n` +
            `‚úÖ **Cherry-pick successful** - no conflicts detected\n\n` +
            `## Testing\n\n` +
            `- [ ] Build test passed\n` +
            `- [ ] Manual testing completed\n` +
            `- [ ] No regressions introduced\n\n` +
            `## Related Issues\n\n` +
            `<!-- Link any related issues here -->\n\n` +
            `---\n\n` +
            `**Auto-created by backport-hotfix workflow**\n` +
            `Requested by: @${context.actor}`;
          
          const pr = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: prTitle,
            head: branchName,
            base: `support/${targetVersion}`,
            body: prBody,
            draft: false
          });
          
          core.info(`‚úÖ Created PR: #${pr.data.number}`);
          core.setOutput('pr_number', pr.data.number);
          
    - name: Report Conflicts (if failed)
      if: steps.cherrypick.outputs.success == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const targetVersion = '${{ inputs.target_version }}';
          const commitSha = '${{ steps.validate.outputs.full_sha }}';
          const commitMsg = `${{ steps.validate.outputs.message }}`;
          
          // –ß–∏—Ç–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
          const fs = require('fs');
          let conflicts = '';
          try {
            conflicts = fs.readFileSync('conflicts.txt', 'utf8');
          } catch (e) {
            conflicts = 'Could not determine conflicting files';
          }
          
          const issueBody = `# Backport Failed: Conflicts Detected\n\n` +
            `## Original Commit\n\n` +
            `- **SHA**: ${commitSha}\n` +
            `- **Target Version**: ${targetVersion}\n` +
            `- **Message**: \n` +
            `  \`\`\`\n` +
            `  ${commitMsg}\n` +
            `  \`\`\`\n\n` +
            `## Problem\n\n` +
            `‚ùå Cherry-pick failed due to merge conflicts.\n\n` +
            `### Conflicting Files\n\n` +
            `\`\`\`\n` +
            `${conflicts}\n` +
            `\`\`\`\n\n` +
            `## Resolution Steps\n\n` +
            `Manual intervention required:\n\n` +
            `1. Checkout support branch:\n` +
            `   \`\`\`bash\n` +
            `   git checkout support/${targetVersion}\n` +
            `   git pull\n` +
            `   \`\`\`\n\n` +
            `2. Cherry-pick commit manually:\n` +
            `   \`\`\`bash\n` +
            `   git cherry-pick ${commitSha}\n` +
            `   \`\`\`\n\n` +
            `3. Resolve conflicts in the files listed above\n\n` +
            `4. Complete cherry-pick:\n` +
            `   \`\`\`bash\n` +
            `   git add <resolved-files>\n` +
            `   git cherry-pick --continue\n` +
            `   \`\`\`\n\n` +
            `5. Push and create PR:\n` +
            `   \`\`\`bash\n` +
            `   git push origin support/${targetVersion}\n` +
            `   \`\`\`\n\n` +
            `---\n\n` +
            `**Auto-created by backport-hotfix workflow**\n` +
            `Requested by: @${context.actor}`;
          
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `[Backport Failed] Cannot backport ${commitSha.substring(0, 7)} to ${targetVersion}`,
            body: issueBody,
            labels: ['backport', 'needs-manual-intervention', `version-${targetVersion}`]
          });
          
          core.info(`‚úÖ Created issue for manual backport: #${issue.data.number}`);
          core.setFailed('Cherry-pick failed - manual intervention required');
          
    - name: Summary
      if: always()
      run: |
        COMMIT="${{ steps.validate.outputs.full_sha }}"
        TARGET="${{ inputs.target_version }}"
        
        echo "## üçí Backport Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: \`${COMMIT:0:7}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Target Version**: ${TARGET}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.cherrypick.outputs.success }}" == "true" ]; then
          echo "‚úÖ **Status**: Cherry-pick successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull request created automatically." >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Status**: Cherry-pick failed (conflicts)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Issue created for manual resolution." >> $GITHUB_STEP_SUMMARY
        fi
