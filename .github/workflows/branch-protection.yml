name: Branch Protection Setup

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð²Ð¸Ð» Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð²ÐµÑ‚Ð¾Ðº
# ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ Ðº: main, develop, support/*

on:
  workflow_dispatch:
    inputs:
      branch_pattern:
        description: 'ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½ Ð²ÐµÑ‚ÐºÐ¸ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸'
        required: true
        type: choice
        options:
          - 'main'
          - 'develop'
          - 'support/*'
          - 'all'
  push:
    branches:
      - 'support/**'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  setup-protection:
    name: Setup Branch Protection
    runs-on: ubuntu-latest
    
    steps:
    - name: Determine Branches
      id: branches
      run: |
        PATTERN="${{ inputs.branch_pattern || 'support/*' }}"
        
        case "$PATTERN" in
          "all")
            BRANCHES="main develop support/*"
            ;;
          "support/*")
            BRANCHES="support/*"
            ;;
          *)
            BRANCHES="$PATTERN"
            ;;
        esac
        
        echo "branches=${BRANCHES}" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ Ð´Ð»Ñ: ${BRANCHES}"
        
    - name: Configure Main Branch Protection
      if: contains(steps.branches.outputs.branches, 'main')
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.repos.updateBranchProtection({
            owner: context.repo.owner,
            repo: context.repo.repo,
            branch: 'main',
            required_status_checks: {
              strict: true,
              contexts: ['build-test', 'check']
            },
            enforce_admins: false,
            required_pull_request_reviews: {
              dismissal_restrictions: {},
              dismiss_stale_reviews: true,
              require_code_owner_reviews: false,
              required_approving_review_count: 1,
              require_last_push_approval: false
            },
            restrictions: null,
            required_linear_history: false,
            allow_force_pushes: false,
            allow_deletions: false,
            block_creations: false,
            required_conversation_resolution: true,
            lock_branch: false,
            allow_fork_syncing: false
          });
          
          core.info('âœ… Branch protection configured for main');
          
    - name: Configure Develop Branch Protection
      if: contains(steps.branches.outputs.branches, 'develop')
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.repos.updateBranchProtection({
            owner: context.repo.owner,
            repo: context.repo.repo,
            branch: 'develop',
            required_status_checks: {
              strict: true,
              contexts: ['build-test', 'check']
            },
            enforce_admins: false,
            required_pull_request_reviews: {
              dismissal_restrictions: {},
              dismiss_stale_reviews: false,
              require_code_owner_reviews: false,
              required_approving_review_count: 1,
              require_last_push_approval: false
            },
            restrictions: null,
            required_linear_history: false,
            allow_force_pushes: false,
            allow_deletions: false,
            block_creations: false,
            required_conversation_resolution: false,
            lock_branch: false,
            allow_fork_syncing: false
          });
          
          core.info('âœ… Branch protection configured for develop');
          
    - name: List Support Branches
      if: contains(steps.branches.outputs.branches, 'support/')
      id: support_branches
      uses: actions/github-script@v7
      with:
        script: |
          const { data: branches } = await github.rest.repos.listBranches({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          const supportBranches = branches
            .filter(b => b.name.startsWith('support/'))
            .map(b => b.name);
          
          core.info(`Found ${supportBranches.length} support branches`);
          supportBranches.forEach(b => core.info(`  - ${b}`));
          
          return supportBranches;
          
    - name: Configure Support Branches Protection
      if: contains(steps.branches.outputs.branches, 'support/')
      uses: actions/github-script@v7
      with:
        script: |
          const supportBranches = ${{ steps.support_branches.outputs.result }};
          
          for (const branch of supportBranches) {
            try {
              await github.rest.repos.updateBranchProtection({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branch,
                required_status_checks: {
                  strict: true,
                  contexts: ['build-test']
                },
                enforce_admins: false,
                required_pull_request_reviews: {
                  dismissal_restrictions: {},
                  dismiss_stale_reviews: true,
                  require_code_owner_reviews: false,
                  required_approving_review_count: 1,
                  require_last_push_approval: false
                },
                restrictions: null,
                required_linear_history: false,
                allow_force_pushes: false,
                allow_deletions: false,
                block_creations: false,
                required_conversation_resolution: true,
                lock_branch: false,
                allow_fork_syncing: false
              });
              
              core.info(`âœ… Branch protection configured for ${branch}`);
            } catch (error) {
              core.warning(`Failed to configure ${branch}: ${error.message}`);
            }
          }
          
    - name: Summary
      run: |
        echo "## ðŸ›¡ï¸ Branch Protection Setup" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Configured branches**: ${{ steps.branches.outputs.branches }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Protection Rules:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Require pull request reviews (1 approval)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Require status checks to pass" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dismiss stale reviews on new commits" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Require conversation resolution" >> $GITHUB_STEP_SUMMARY
        echo "- âŒ Force pushes disabled" >> $GITHUB_STEP_SUMMARY
        echo "- âŒ Branch deletion disabled" >> $GITHUB_STEP_SUMMARY
