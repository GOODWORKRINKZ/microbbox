# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx reverse proxy –¥–ª—è WebXR –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ESP32

## –û–±–∑–æ—Ä —Ä–µ—à–µ–Ω–∏—è

–î–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebXR —Å ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ —á–µ—Ä–µ–∑ HTTPS —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ –æ—Ç Let's Encrypt. –°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:

1. **Raspberry Pi Zero —Å Ubuntu** - —Ö–æ—Å—Ç –¥–ª—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
2. **nginx –≤ Docker** - reverse proxy —Å SSL —Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–µ–π
3. **certbot –≤ Docker** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
4. **–†–æ—É—Ç–µ—Ä Keenetic Viva** - –ª–æ–∫–∞–ª—å–Ω—ã–π DNS –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–æ–º–µ–Ω–Ω—ã—Ö –∏–º–µ–Ω

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Internet/Local Network
         |
         v
    [Router Keenetic Viva]
    - DNS Server (–ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–æ–º–µ–Ω—ã)
    - DHCP Server (—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ IP)
         |
         v
    [Raspberry Pi Zero]
    - nginx (Docker)
    - certbot (Docker)
         |
         +---> ESP32 #1 (192.168.1.100:80, :81)
         +---> ESP32 #2 (192.168.1.101:80, :81)
         +---> ESP32 #3 (192.168.1.102:80, :81)
```

### –ü–æ—Ä—Ç—ã ESP32

–ö–∞–∂–¥–æ–µ ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–∞ –ø–æ—Ä—Ç–∞:
- **–ü–æ—Ä—Ç 80** - –æ—Å–Ω–æ–≤–Ω–æ–µ API –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **–ü–æ—Ä—Ç 81** - –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ —Å –∫–∞–º–µ—Ä—ã

nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –æ–±–∞ –ø–æ—Ä—Ç–∞ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:
- `https://robot1.example.com/` ‚Üí `http://192.168.1.100:80/` (API)
- `https://robot1.example.com/stream` ‚Üí `http://192.168.1.100:81/` (–≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫)

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
- Raspberry Pi Zero W/2W —Å Ubuntu (–∏–ª–∏ –¥—Ä—É–≥–∞—è Linux —Å–∏—Å—Ç–µ–º–∞)
- –†–æ—É—Ç–µ—Ä Keenetic Viva –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ DNS
- ESP32-CAM —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (MicroRoBox)

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ
- Docker –∏ Docker Compose
- –î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è A-–∑–∞–ø–∏—Å–µ–π
- –ü–æ—Ä—Ç—ã 80 –∏ 443 –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –Ω–∞ Raspberry Pi

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
sudo apt update && sudo apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
sudo usermod -aG docker $USER

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose
sudo apt install docker-compose -y

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
docker --version
docker-compose --version
```

### 2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ Raspberry Pi

```bash
# –ù–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ, –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
cd nginx-proxy

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Raspberry Pi (–∑–∞–º–µ–Ω–∏—Ç–µ IP –∞–¥—Ä–µ—Å)
scp -r . pi@192.168.1.50:~/microbbox-proxy/

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Raspberry Pi
ssh pi@192.168.1.50
cd ~/microbbox-proxy
```

### 3. –ó–∞–ø—É—Å–∫ nginx –∏ certbot

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
mkdir -p certbot/{conf,www,logs} nginx/logs

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
docker-compose ps
docker-compose logs -f
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `add-device.sh` –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞:

```bash
sudo ./scripts/add-device.sh
```

–°–∫—Ä–∏–ø—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç:
- –ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `robot1`)
- IP –∞–¥—Ä–µ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `192.168.1.100`)
- –î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `robot1.example.com`)
- –ü–æ—Ä—Ç API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `80`)
- –ü–æ—Ä—Ç –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `81`)

### –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —à–∞–±–ª–æ–Ω:
```bash
cp nginx/templates/device-template.conf nginx/conf.d/robot1.example.com.conf
```

2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª, –∑–∞–º–µ–Ω–∏–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
```bash
nano nginx/conf.d/robot1.example.com.conf

# –ó–∞–º–µ–Ω–∏—Ç–µ:
# DEVICE_NAME -> robot1
# DEVICE_IP -> 192.168.1.100
# DOMAIN_NAME -> robot1.example.com
# API_PORT -> 80
# STREAM_PORT -> 81
```

3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ nginx:
```bash
docker exec microbbox-nginx nginx -s reload
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ Keenetic Viva

### –ú–µ—Ç–æ–¥ 1: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–æ—É—Ç–µ—Ä–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–æ—É—Ç–µ—Ä–∞: `http://192.168.1.1` (–∏–ª–∏ –¥—Ä—É–≥–æ–π IP –≤–∞—à–µ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞)
2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"** ‚Üí **"–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"** ‚Üí **"–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"**
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç **"DNS-–ø—Ä–æ–∫—Å–∏"** –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
5. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **"–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ñ–∏–ª—å—Ç—Ä—ã"** ‚Üí **"–°–µ—Ä–≤–µ—Ä—ã –∏–º–µ–Ω"** ‚Üí **"–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–æ–º–µ–Ω–Ω—ã–µ –∏–º–µ–Ω–∞"**
6. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:
   - –ò–º—è: `robot1.example.com`
   - IP –∞–¥—Ä–µ—Å: `192.168.1.50` (IP Raspberry Pi)

### –ú–µ—Ç–æ–¥ 2: –ß–µ—Ä–µ–∑ telnet/SSH

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–æ—É—Ç–µ—Ä—É
telnet 192.168.1.1

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ DNS –∑–∞–ø–∏—Å–µ–π
ip name robot1.example.com 192.168.1.50
ip name robot2.example.com 192.168.1.50
ip name robot3.example.com 192.168.1.50

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
system configuration save
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS

```bash
# –ù–∞ –ª—é–±–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏
nslookup robot1.example.com
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å IP –∞–¥—Ä–µ—Å Raspberry Pi: 192.168.1.50
```

## –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ IP –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è ESP32

### –ù–∞ —Ä–æ—É—Ç–µ—Ä–µ Keenetic Viva

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–æ—É—Ç–µ—Ä–∞
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **"–î–æ–º–∞—à–Ω—è—è —Å–µ—Ç—å"** ‚Üí **"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"**
3. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (–ø–æ MAC –∞–¥—Ä–µ—Å—É –∏–ª–∏ –∏–º–µ–Ω–∏ `MICROBBOX-XXXXXX`)
4. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ‚Üí **"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"**
5. –í–∫–ª—é—á–∏—Ç–µ **"–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π IP-–∞–¥—Ä–µ—Å"**
6. –£–∫–∞–∂–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π IP –∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `192.168.1.100`)
7. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ö–µ–º–∞ –∞–¥—Ä–µ—Å–∞—Ü–∏–∏:
- `192.168.1.100` - robot1
- `192.168.1.101` - robot2
- `192.168.1.102` - robot3
- –∏ —Ç.–¥.

## –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `obtain-certificate.sh`:

```bash
# –° —É–∫–∞–∑–∞–Ω–∏–µ–º email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
sudo ./scripts/obtain-certificate.sh robot1.example.com admin@example.com

# –ë–µ–∑ email
sudo ./scripts/obtain-certificate.sh robot1.example.com
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

1. **–ü—É–±–ª–∏—á–Ω—ã–π DNS**: –î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –¥–æ–ª–∂–Ω–æ —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è –Ω–∞ –≤–Ω–µ—à–Ω–∏–π IP –≤–∞—à–µ–π —Å–µ—Ç–∏
   - –°–æ–∑–¥–∞–π—Ç–µ A-–∑–∞–ø–∏—Å—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞, —É–∫–∞–∑—ã–≤–∞—é—â—É—é –Ω–∞ –≤–Ω–µ—à–Ω–∏–π IP
   - –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DynDNS –µ—Å–ª–∏ —É –≤–∞—Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π IP

2. **–ü—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ port forwarding –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ
   - –ü–æ—Ä—Ç 80 ‚Üí Raspberry Pi (192.168.1.50:80)
   - –ü–æ—Ä—Ç 443 ‚Üí Raspberry Pi (192.168.1.50:443)

3. **–õ–æ–∫–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ï—Å–ª–∏ –Ω—É–∂–µ–Ω HTTPS —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è WebXR)
   - –ò–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π DNS (DNS-01 challenge)

### –†—É—á–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

```bash
# –î–ª—è –æ–¥–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞
docker exec microbbox-certbot certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email admin@example.com \
  --agree-tos \
  --domain robot1.example.com

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
docker exec microbbox-nginx nginx -s reload
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

Certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Let's Encrypt –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 90 –¥–Ω–µ–π –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∑–∞ 30 –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è.

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:
```bash
docker exec microbbox-certbot certbot certificates
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

nginx –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:

1. **max_fails=3** - –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ upstream
2. **fail_timeout=30s** - –≤—Ä–µ–º—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ upstream —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
3. **–ö–∞—Å—Ç–æ–º–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—à–∏–±–∫–∏** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

–ö–æ–≥–¥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ, nginx –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–Ω–µ—Ç –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx

```bash
# –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose ps

# –õ–æ–≥–∏ nginx
docker logs microbbox-nginx

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
docker exec microbbox-nginx nginx -t

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx
docker exec microbbox-nginx nginx -s reload
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

```bash
# –ò–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏
curl -I http://robot1.example.com
curl -I https://robot1.example.com

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞
curl -I https://robot1.example.com/stream
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

```bash
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö
docker exec microbbox-certbot certbot certificates

# –¢–µ—Å—Ç SSL —Å –ø–æ–º–æ—â—å—é openssl
openssl s_client -connect robot1.example.com:443 -servername robot1.example.com
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å WebXR

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã, –≤–∞—à–∏ ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ HTTPS —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –≤ VR –≥–∞—Ä–Ω–∏—Ç—É—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Oculus Browser)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ `https://robot1.example.com`
3. –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–µ
4. WebXR API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (—Ç—Ä–µ–±—É–µ—Ç HTTPS)
5. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **ü•Ω VR** –¥–ª—è –≤—Ö–æ–¥–∞ –≤ VR —Ä–µ–∂–∏–º

## –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã

```bash
docker-compose down
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
nano nginx/conf.d/robot1.example.com.conf

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
docker exec microbbox-nginx nginx -t

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
docker exec microbbox-nginx nginx -s reload
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# –í—Å–µ –ª–æ–≥–∏
docker-compose logs

# –õ–æ–≥–∏ nginx
docker-compose logs nginx

# –õ–æ–≥–∏ certbot
docker-compose logs certbot

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
tail -f nginx/logs/robot1-access.log
tail -f nginx/logs/robot1-error.log
```

### –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

```bash
# –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
rm nginx/conf.d/robot1.example.com.conf

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx
docker exec microbbox-nginx nginx -s reload
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ proxy

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
1. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–∫–ª—é—á–µ–Ω–æ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ç–∏
   ```bash
   ping 192.168.1.100
   ```

2. –ü–æ—Ä—Ç—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–æ—Å—Ç—É–ø–Ω—ã
   ```bash
   curl http://192.168.1.100:80
   curl http://192.168.1.100:81
   ```

3. nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
   ```bash
   docker exec microbbox-nginx nginx -t
   ```

4. nginx –∑–∞–ø—É—â–µ–Ω
   ```bash
   docker-compose ps
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
1. DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   ```bash
   nslookup robot1.example.com
   dig robot1.example.com
   ```

2. –ü–æ—Ä—Ç 80 –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
   ```bash
   curl -I http://robot1.example.com/.well-known/acme-challenge/test
   ```

3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ certbot
   ```bash
   docker logs microbbox-certbot
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: WebXR –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
1. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTTPS (WebXR —Ç—Ä–µ–±—É–µ—Ç HTTPS)
2. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞–ª–∏–¥–µ–Ω (–Ω–µ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π)
3. –í –±—Ä–∞—É–∑–µ—Ä–µ –≤–∫–ª—é—á–µ–Ω—ã WebXR —Ñ—É–Ω–∫—Ü–∏–∏
4. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebXR (Oculus Quest/Quest 2)

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

### –ü—Ä–∏–º–µ—Ä –¥–ª—è 3 —É—Å—Ç—Ä–æ–π—Å—Ç–≤

```bash
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
sudo ./scripts/add-device.sh
# robot1, 192.168.1.100, robot1.example.com

sudo ./scripts/add-device.sh
# robot2, 192.168.1.101, robot2.example.com

sudo ./scripts/add-device.sh
# robot3, 192.168.1.102, robot3.example.com

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
sudo ./scripts/obtain-certificate.sh robot1.example.com admin@example.com
sudo ./scripts/obtain-certificate.sh robot2.example.com admin@example.com
sudo ./scripts/obtain-certificate.sh robot3.example.com admin@example.com
```

### DNS –∑–∞–ø–∏—Å–∏ –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ

```
robot1.example.com ‚Üí 192.168.1.50 (Raspberry Pi)
robot2.example.com ‚Üí 192.168.1.50 (Raspberry Pi)
robot3.example.com ‚Üí 192.168.1.50 (Raspberry Pi)
```

### –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ DHCP

```
ESP32 MAC xx:xx:xx:xx:xx:01 ‚Üí 192.168.1.100 (robot1)
ESP32 MAC xx:xx:xx:xx:xx:02 ‚Üí 192.168.1.101 (robot2)
ESP32 MAC xx:xx:xx:xx:xx:03 ‚Üí 192.168.1.102 (robot3)
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏** –¥–ª—è —Ä–æ—É—Ç–µ—Ä–∞ –∏ Raspberry Pi
2. **–û–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–∏—Å—Ç–µ–º—É** —Ä–µ–≥—É–ª—è—Ä–Ω–æ
   ```bash
   sudo apt update && sudo apt upgrade -y
   docker-compose pull
   docker-compose up -d
   ```

3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ firewall** –Ω–∞ Raspberry Pi
   ```bash
   sudo apt install ufw
   sudo ufw allow 22/tcp  # SSH
   sudo ufw allow 80/tcp  # HTTP
   sudo ufw allow 443/tcp # HTTPS
   sudo ufw enable
   ```

4. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –ø–æ SSH** —Ç–æ–ª—å–∫–æ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏

5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   ```bash
   tail -f nginx/logs/access.log | grep -v "192.168"
   ```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Raspberry Pi Zero

Raspberry Pi Zero –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤** - –Ω–µ –±–æ–ª–µ–µ 3-5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ swap** –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ RAM
3. **–û—Ç–∫–ª—é—á–∏—Ç–µ –Ω–µ–Ω—É–∂–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã** –Ω–∞ Raspberry Pi
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   ```bash
   htop
   docker stats
   ```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

–î–ª—è –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
- Raspberry Pi 3/4 (–±–æ–ª—å—à–µ RAM –∏ CPU)
- Intel NUC –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π mini-PC
- VPS/–æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Prometheus –∏ Grafana –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

```yaml
# –î–æ–±–∞–≤–∏—Ç—å –≤ docker-compose.yml
  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS

–î–æ–±–∞–≤—å—Ç–µ rate limiting –≤ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```nginx
http {
    limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;
    
    server {
        location / {
            limit_req zone=mylimit burst=20;
            # ...
        }
    }
}
```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs`
2. –°–æ–∑–¥–∞–π—Ç–µ Issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é nginx –∏ Let's Encrypt

## –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π MIT.
