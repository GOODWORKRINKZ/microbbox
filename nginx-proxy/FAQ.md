# FAQ - Часто задаваемые вопросы

## Общие вопросы

### Зачем нужен nginx reverse proxy?

WebXR API (используемый для VR) требует HTTPS с валидными SSL сертификатами. ESP32 не может эффективно обрабатывать SSL из-за ограниченных ресурсов. nginx решает эту проблему, выполняя SSL терминацию и проксируя запросы к ESP32 по обычному HTTP.

### Можно ли использовать другие роутеры кроме Keenetic Viva?

Да! Любой роутер с поддержкой:
- Локального DNS (или возможность редактирования hosts файла)
- DHCP резервирования IP адресов
- Проброса портов (port forwarding)

Подходят практически все современные роутеры: Mikrotik, TP-Link, Asus, D-Link, OpenWRT, DD-WRT и др.

### Обязательно ли использовать Raspberry Pi?

Нет, можно использовать любую Linux систему:
- Raspberry Pi 2/3/4 (больше производительности)
- Старый ноутбук или ПК с Linux
- Intel NUC
- VPS/облачный сервер

Главное требование - возможность запуска Docker.

### Сколько устройств можно подключить?

**Raspberry Pi Zero:** 3-5 устройств с одновременным использованием
**Raspberry Pi 3/4:** 10-20 устройств
**Полноценный ПК/сервер:** 50+ устройств

Ограничение в основном по пропускной способности сети и ресурсам процессора/памяти.

## Технические вопросы

### Как работает маппинг портов ESP32?

ESP32 предоставляет два порта:
- **Порт 80** - веб-интерфейс и API
- **Порт 81** - видеопоток с камеры

nginx проксирует их следующим образом:
```
https://robot1.example.com/        → http://192.168.1.100:80/
https://robot1.example.com/stream  → http://192.168.1.100:81/
```

Это позволяет использовать один домен вместо двух.

### Что произойдет если ESP32 выключен?

nginx автоматически обнаружит недоступность устройства и отобразит красивую страницу ошибки с автоматической попыткой переподключения каждые 10 секунд. Когда устройство вернется в сеть, все заработает автоматически.

### Как часто обновляются SSL сертификаты?

Let's Encrypt сертификаты действительны 90 дней. certbot автоматически обновляет их за 30 дней до истечения, проверяя каждые 12 часов. Вам не нужно делать ничего вручную.

### Нужен ли статический внешний IP адрес?

Нет, можно использовать динамический IP с DDNS сервисом (DynDNS, No-IP и др.). Многие роутеры, включая Keenetic, имеют встроенную поддержку DDNS.

### Можно ли использовать без доменного имени?

Технически да, но Let's Encrypt требует доменное имя для выдачи сертификата. Варианты:
1. Купить дешевый домен (~$5-10/год)
2. Использовать бесплатные домены (например, от Freenom)
3. Использовать DDNS с поддоменом (например, myrobots.ddns.net)

### Безопасно ли открывать порты 80 и 443 в интернет?

Да, при правильной настройке. Рекомендации:
- Используйте сильные пароли на ESP32 и роутере
- Регулярно обновляйте систему
- Настройте firewall на Raspberry Pi
- Мониторьте логи на подозрительную активность
- После получения сертификатов можно закрыть порт 80 (оставить только 443)

## Проблемы и решения

### Не могу получить SSL сертификат

**Проверьте:**
1. DNS правильно настроен и резолвится на ваш публичный IP
   ```bash
   dig robot1.example.com
   nslookup robot1.example.com
   ```

2. Порт 80 открыт и доступен из интернета
   ```bash
   # С внешнего сервера или используйте онлайн-инструменты
   telnet YOUR_PUBLIC_IP 80
   ```

3. nginx работает
   ```bash
   docker ps | grep nginx
   ```

4. Домен резолвится на правильный IP
   ```bash
   curl -I http://robot1.example.com/.well-known/acme-challenge/test
   ```

### ESP32 недоступен через proxy

**Проверьте:**
1. Устройство включено и в сети
   ```bash
   ping 192.168.1.100
   ```

2. Порты доступны напрямую
   ```bash
   curl http://192.168.1.100:80
   curl http://192.168.1.100:81
   ```

3. IP адрес правильный в конфигурации nginx
   ```bash
   cat nginx/conf.d/robot1.example.com.conf | grep "server.*:80"
   ```

4. nginx перезагружен после изменений
   ```bash
   docker exec microbbox-nginx nginx -s reload
   ```

### DNS не работает в локальной сети

**Проверьте:**
1. DNS сервер на роутере включен
2. Клиентские устройства используют роутер как DNS
   ```bash
   # На Windows
   ipconfig /all
   # Найдите "DNS-серверы" - должен быть IP роутера
   
   # На Linux/macOS
   cat /etc/resolv.conf
   # Должна быть строка: nameserver 192.168.1.1
   ```

3. Очистите DNS кэш
   ```bash
   # Windows
   ipconfig /flushdns
   
   # macOS
   sudo dscacheutil -flushcache
   
   # Linux
   sudo systemd-resolve --flush-caches
   ```

### WebXR не работает даже с HTTPS

**Проверьте:**
1. Сертификат валиден (не самоподписанный)
   - Откройте сайт в браузере
   - Кликните на замочек в адресной строке
   - Проверьте, что сертификат выдан Let's Encrypt

2. Используется именно HTTPS (не HTTP)

3. Браузер поддерживает WebXR
   - На Quest используйте Oculus Browser (рекомендуется)
   - Или Firefox Reality / Wolvic

4. JavaScript консоль не показывает ошибок
   - Откройте DevTools (F12)
   - Проверьте вкладку Console

### Медленная работа видеопотока

**Оптимизация:**
1. Проверьте загрузку CPU на Raspberry Pi
   ```bash
   htop
   ```

2. Используйте более мощное устройство (Pi 3/4 вместо Pi Zero)

3. Оптимизируйте настройки камеры ESP32
   - Снизьте разрешение
   - Уменьшите FPS

4. Проверьте качество WiFi сигнала
   - ESP32 должен быть близко к роутеру
   - Используйте WiFi 5GHz если возможно

### Контейнеры постоянно перезапускаются

**Проверьте:**
1. Логи контейнеров
   ```bash
   docker-compose logs
   ```

2. Ресурсы системы
   ```bash
   free -h  # Память
   df -h    # Диск
   ```

3. Права на директории
   ```bash
   ls -la nginx/logs certbot/conf
   ```

4. Конфигурацию nginx
   ```bash
   docker exec microbbox-nginx nginx -t
   ```

## Расширенные возможности

### Можно ли добавить мониторинг?

Да! Используйте расширенную конфигурацию:
```bash
# Запуск с мониторингом
docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml --profile monitoring up -d

# Доступ к Grafana
http://192.168.1.50:3000
# Логин: admin, Пароль: admin
```

### Можно ли использовать Basic Auth для защиты?

Да, добавьте в конфигурацию nginx:
```nginx
server {
    # ...
    location / {
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;
        proxy_pass http://robot1_api;
        # ...
    }
}
```

Создайте файл паролей:
```bash
# На Raspberry Pi
sudo apt install apache2-utils
htpasswd -c nginx/.htpasswd admin
docker exec microbbox-nginx nginx -s reload
```

### Можно ли ограничить доступ по IP?

Да, добавьте в конфигурацию:
```nginx
server {
    # ...
    # Разрешить только локальную сеть
    allow 192.168.1.0/24;
    deny all;
    
    # Или разрешить конкретные IP
    allow 192.168.1.100;
    allow 203.0.113.5;
    deny all;
}
```

### Можно ли использовать несколько доменов для одного устройства?

Да, добавьте альтернативные имена в `server_name`:
```nginx
server {
    listen 443 ssl http2;
    server_name robot1.example.com robot-one.example.com myrobot.example.com;
    # ...
}
```

И получите wildcard сертификат:
```bash
sudo ./scripts/obtain-certificate.sh "*.example.com" admin@example.com
```

## Производительность

### Какая нагрузка на Raspberry Pi?

**Idle (без подключений):**
- CPU: 5-10%
- RAM: 100-150 MB
- Сеть: минимальная

**Активное использование (1 устройство с видеопотоком):**
- CPU: 20-40%
- RAM: 200-300 MB
- Сеть: 1-5 Mbps

### Как уменьшить задержку видеопотока?

1. Используйте проводное подключение для Raspberry Pi
2. ESP32 подключайте по WiFi 5GHz если возможно
3. Оптимизируйте nginx буферизацию (уже настроено в конфигурации)
4. Уменьшите разрешение камеры ESP32
5. Разместите устройства ближе к роутеру

### Сколько места занимают логи?

Логи nginx могут расти довольно быстро. Рекомендуется настроить ротацию:
```bash
# Создайте файл logrotate
sudo nano /etc/logrotate.d/microbbox-nginx

# Добавьте:
/home/pi/microbbox/nginx-proxy/nginx/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        docker exec microbbox-nginx nginx -s reload > /dev/null 2>&1 || true
    endscript
}
```

## Другие вопросы

### Можно ли использовать эту настройку для других ESP32 проектов?

Да! Эта конфигурация подходит для любых ESP32 устройств, предоставляющих веб-интерфейс. Просто измените конфигурацию под ваши нужды.

### Есть ли альтернативы nginx?

Да, можно использовать:
- **Traefik** - автоматическое получение SSL, но сложнее в настройке
- **Caddy** - проще nginx, автоматический HTTPS
- **HAProxy** - более продвинутый балансировщик

Но nginx рекомендуется для данного случая из-за простоты, стабильности и производительности.

### Нужен ли мне этот proxy если я использую только HTTP?

Если вы не планируете использовать WebXR и вас устраивает HTTP, то proxy не нужен. Но для WebXR HTTPS с валидным сертификатом обязателен.

### Поддерживается ли IPv6?

Текущая конфигурация использует только IPv4. Для поддержки IPv6 нужно добавить в nginx конфигурацию:
```nginx
listen 443 ssl http2;
listen [::]:443 ssl http2;  # IPv6
```

### Где найти помощь если мой вопрос не здесь?

1. Проверьте [README.md](README.md) - основная документация
2. Посмотрите [QUICKSTART.md](QUICKSTART.md) - быстрый старт
3. Изучите [KEENETIC_SETUP.md](KEENETIC_SETUP.md) - настройка роутера
4. Создайте Issue в репозитории проекта на GitHub
5. Проверьте логи: `docker-compose logs`

---

**Не нашли ответ на свой вопрос?** Создайте Issue на GitHub, мы постараемся помочь!
