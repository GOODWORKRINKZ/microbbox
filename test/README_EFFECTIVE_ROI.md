# –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (ROI) —Å —É—á–µ—Ç–æ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–ò–∑-–∑–∞ **—Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∫–∞–º–µ—Ä—ã ESP32CAM** –Ω–µ –≤—Å—è –æ–±–ª–∞—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏–≥–æ–¥–Ω–∞ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ª–∏–Ω–∏–∏:

### –§–∏–∑–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

1. **–ü–µ—Ä–µ—Å–≤–µ—Ç (Overexposure)**
   - –Ø—Ä–∫–∏–µ –æ–±–ª–∞—Å—Ç–∏ —Å –ø–æ—Ç–µ—Ä–µ–π –¥–µ—Ç–∞–ª–µ–π
   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞–∑–ª–∏—á–∏—Ç—å –ª–∏–Ω–∏—é –Ω–∞ –ø–µ—Ä–µ—Å–≤–µ—á–µ–Ω–Ω–æ–º —Ñ–æ–Ω–µ

2. **–ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ (Underexposure)**
   - –¢–µ–º–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ —Å –Ω–∏–∑–∫–∏–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º
   - –ù–∞ –±–µ–ª–æ–º —Ñ–æ–Ω–µ: 8.21% –æ–±–ª–∞—Å—Ç–∏ –∑–∞—Ç–µ–º–Ω–µ–Ω–∞
   - –õ–∏–Ω–∏—è –ø–ª–æ—Ö–æ –≤–∏–¥–Ω–∞ –≤ –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–∫–∞—Ö

3. **–û—Ç—Ä–∞–∂–µ–Ω–∏–µ LED**
   - –Ø—Ä–∫–æ–µ –ø—è—Ç–Ω–æ –æ—Ç —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞ –∫–∞–º–µ—Ä—ã (–º–∞–∫—Å. —è—Ä–∫–æ—Å—Ç—å = 255)
   - –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ –≤—Å–µ—Ö –∫–∞–¥—Ä–∞—Ö

4. **–í–∏–Ω—å–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –¢–∏–ø–∏—á–Ω–æ –¥–ª—è –Ω–µ–¥–æ—Ä–æ–≥–∏—Ö –∫–∞–º–µ—Ä

---

## üí° –†–µ—à–µ–Ω–∏–µ

–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ **—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é –æ–±–ª–∞—Å—Ç—å (ROI - Region of Interest)** –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ª–∏–Ω–∏–∏.

### –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:

```
–≠–§–§–ï–ö–¢–ò–í–ù–ê–Ø –û–ë–õ–ê–°–¢–¨ (ROI):
  Y: 11 - 102 (–≤—ã—Å–æ—Ç–∞: 91 px, 75.8% –æ—Ç –æ–±—â–µ–π)
  X: 16 - 144 (—à–∏—Ä–∏–Ω–∞: 128 px, 80.0% –æ—Ç –æ–±—â–µ–π)
  
–ü–ª–æ—â–∞–¥—å ROI: 60.7% –æ—Ç –æ–±—â–µ–π –ø–ª–æ—â–∞–¥–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã –æ–±–ª–∞—Å—Ç–∏ —Å –ø–µ—Ä–µ—Å–≤–µ—Ç–æ–º
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã –æ–±–ª–∞—Å—Ç–∏ —Å –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ–º
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (~40%)

---

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö

–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö:

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|----------------------|-----------|
| **–ü—Ä—è–º–∞—è –ª–∏–Ω–∏—è** | 15 | ‚úÖ –î–µ—Ç–µ–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **–ü–æ–≤–æ—Ä–æ—Ç –≤–ª–µ–≤–æ** | 16 | ‚úÖ –î–µ—Ç–µ–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **–ü–æ–≤–æ—Ä–æ—Ç –≤–ø—Ä–∞–≤–æ** | 16 | ‚úÖ –î–µ—Ç–µ–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **–û–∫–æ–Ω—á–∞–Ω–∏–µ –ª–∏–Ω–∏–∏** | 33 | ‚úÖ –î–µ—Ç–µ–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç |

**–í—Å–µ–≥–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:** 80 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

---

## üî¨ –ê–Ω–∞–ª–∏–∑ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏

### –ë–µ–ª—ã–π —Ñ–æ–Ω (calibration image):

```
–ü–µ—Ä–µ—Å–≤–µ—Ç (>240):       0.00%  ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º
–ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ (<20):      8.21%  ‚ö†Ô∏è –ï—Å—Ç—å —Ç–µ–º–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å:  91.79%  ‚úÖ –ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –ø—Ä–∏–≥–æ–¥–Ω–∞
```

### –ü—Ä–æ—Ñ–∏–ª–∏ —è—Ä–∫–æ—Å—Ç–∏:

**–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–ø–æ –≤—ã—Å–æ—Ç–µ):**
- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –≤ –≤–µ—Ä—Ö–Ω–∏—Ö —Ä—è–¥–∞—Ö (Y < 11)
- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –≤ –Ω–∏–∂–Ω–∏—Ö —Ä—è–¥–∞—Ö (Y > 102)
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ

**–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å (–ø–æ —à–∏—Ä–∏–Ω–µ):**
- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –±–æ–∫–∞–º (X < 16, X > 144)
- –ü–∏–∫ LED –≤ —Ü–µ–Ω—Ç—Ä–µ (–∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—á–∏—Ç–∞–Ω–∏–∏)
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å –≤ —Å—Ä–µ–¥–Ω–µ–π —á–∞—Å—Ç–∏

---

## üíª –ö–æ–¥ –¥–ª—è ESP32

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ROI (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ):

```cpp
// –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å (–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã)
const int ROI_Y_START = 11;
const int ROI_Y_END = 102;
const int ROI_X_START = 16;
const int ROI_X_END = 144;

const int ROI_HEIGHT = ROI_Y_END - ROI_Y_START;  // 91 px
const int ROI_WIDTH = ROI_X_END - ROI_X_START;    // 128 px
```

### –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ ROI:

```cpp
// –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ (–æ–¥–∏–Ω —Ä–∞–∑)
uint8_t white_bg[160*120];
camera_fb_t* fb = esp_camera_fb_get();
memcpy(white_bg, fb->buf, 160*120);
esp_camera_fb_return(fb);

// –í —Ä–∞–±–æ—á–µ–º —Ü–∏–∫–ª–µ - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–û–õ–¨–ö–û –≤ ROI
void detect_line() {
    camera_fb_t* fb = esp_camera_fb_get();
    uint8_t mask[160*120] = {0};  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω—É–ª—è–º–∏
    
    // –°–∫–∞–Ω–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    for (int y = ROI_Y_START; y < ROI_Y_END; y++) {
        for (int x = ROI_X_START; x < ROI_X_END; x++) {
            int i = y * 160 + x;
            int16_t diff = white_bg[i] - fb->buf[i];
            mask[i] = (diff > 30) ? 255 : 0;
        }
    }
    
    // mask —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏–Ω–∏—é —Ç–æ–ª—å–∫–æ –≤ ROI
    // –û–±–ª–∞—Å—Ç–∏ –≤–Ω–µ ROI = 0 (—á–µ—Ä–Ω—ã–µ)
    
    float position = calculate_line_position_roi(mask);
    control_robot(position);
    
    esp_camera_fb_return(fb);
}
```

### –≠–∫–æ–Ω–æ–º–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π:

```
–ë–µ–∑ ROI:  160 √ó 120 = 19,200 –ø–∏–∫—Å–µ–ª–µ–π (100%)
–° ROI:    128 √ó 91  = 11,648 –ø–∏–∫—Å–µ–ª–µ–π (60.7%)

–≠–∫–æ–Ω–æ–º–∏—è: ~40% –≤—ã—á–∏—Å–ª–µ–Ω–∏–π!
–°–∫–æ—Ä–æ—Å—Ç—å: ~0.3 –º—Å –≤–º–µ—Å—Ç–æ ~0.5 –º—Å @ 240 MHz
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏:

```bash
cd test
python3 test_effective_roi.py \
    ../data/img_calibration/calibration_*.jpg \
    --straight ../data/img_straight \
    --left ../data/img_left \
    --right ../data/img_right \
    --terminate ../data/img_terminate
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç:

```
üîç –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏...
   –í—Å–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: 21

‚úÖ –≠–§–§–ï–ö–¢–ò–í–ù–ê–Ø –û–ë–õ–ê–°–¢–¨ (ROI):
   Y: 11 - 102 (–≤—ã—Å–æ—Ç–∞: 91 px, 75.8%)
   X: 16 - 144 (—à–∏—Ä–∏–Ω–∞: 128 px, 80.0%)
   –ü–ª–æ—â–∞–¥—å ROI: 60.7% –æ—Ç –æ–±—â–µ–π –ø–ª–æ—â–∞–¥–∏

üìä –ê–Ω–∞–ª–∏–∑ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏ –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞:
   –ü–µ—Ä–µ—Å–≤–µ—Ç: 0.00%
   –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ: 8.21%
   –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å: 91.79%

‚úÖ –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö:
   ‚Ä¢ –ü—Ä—è–º–∞—è: 3 –ø—Ä–∏–º–µ—Ä–æ–≤
   ‚Ä¢ –í–ª–µ–≤–æ: 3 –ø—Ä–∏–º–µ—Ä–æ–≤
   ‚Ä¢ –í–ø—Ä–∞–≤–æ: 3 –ø—Ä–∏–º–µ—Ä–æ–≤
   ‚Ä¢ –û–∫–æ–Ω—á–∞–Ω–∏–µ: 3 –ø—Ä–∏–º–µ—Ä–æ–≤
```

---

## üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é `output/roi_analysis_all_scenarios.png`:

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**

**–°—Ç—Ä–æ–∫–∞ 1: –ê–Ω–∞–ª–∏–∑ –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞**
- –ë–µ–ª—ã–π —Ñ–æ–Ω + ROI (–∑–µ–ª–µ–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫)
- –ö–∞—Ä—Ç–∞ –ø–µ—Ä–µ—Å–≤–µ—Ç–∞ (–∫—Ä–∞—Å–Ω–∞—è)
- –ö–∞—Ä—Ç–∞ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è (—Å–∏–Ω—è—è)
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å (–∑–µ–ª–µ–Ω–∞—è)
- ROI —Å –±–µ–ª—ã–º —Ñ–æ–Ω–æ–º

**–°—Ç—Ä–æ–∫–∞ 2: –ü—Ä–æ—Ñ–∏–ª–∏ —è—Ä–∫–æ—Å—Ç–∏**
- –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ –±–æ–∫–∞–º –∏ –ø–∏–∫ LED

**–°—Ç—Ä–æ–∫–∏ 3-6: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º**
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω—ã –ø—Ä–∏–º–µ—Ä—ã —Å –Ω–∞–ª–æ–∂–µ–Ω–Ω–æ–π –º–∞—Å–∫–æ–π
- –ì—Ä–∞–Ω–∏—Ü–∞ ROI –ø–æ–∫–∞–∑–∞–Ω–∞ –∑–µ–ª–µ–Ω—ã–º
- –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–∞ –∫—Ä–∞—Å–Ω—ã–º

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –ü–æ—Ä–æ–≥–∏ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏:

```python
# –í —Ñ—É–Ω–∫—Ü–∏–∏ analyze_exposure_map()
overexposure_thresh = 240   # –ü–æ—Ä–æ–≥ –ø–µ—Ä–µ—Å–≤–µ—Ç–∞ (default: 240)
underexposure_thresh = 20   # –ü–æ—Ä–æ–≥ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è (default: 20)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –£–≤–µ–ª–∏—á—å—Ç–µ `overexposure_thresh` –µ—Å–ª–∏ –º–Ω–æ–≥–æ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –Ω–∞ –ø–µ—Ä–µ—Å–≤–µ—Ç
- –£–≤–µ–ª–∏—á—å—Ç–µ `underexposure_thresh` –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å –±–æ–ª—å—à–µ —Ç–µ–º–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π

### –ó–∞–ø–∞—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

```python
# –í —Ñ—É–Ω–∫—Ü–∏–∏ calculate_effective_roi()
safety_margin = 0.1  # 10% –æ—Ç—Å—Ç—É–ø –æ—Ç –≥—Ä–∞–Ω–∏—Ü (default: 0.1)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –£–≤–µ–ª–∏—á—å—Ç–µ –¥–æ 0.15-0.20 –¥–ª—è –±–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–π ROI
- –£–º–µ–Ω—å—à–∏—Ç–µ –¥–æ 0.05 –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å

---

## üìä –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã

### –í–∞—Ä–∏–∞–Ω—Ç 1: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è ROI

–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å ROI –Ω–∞ –∫–∞–∂–¥–æ–º –∫–∞–¥—Ä–µ:

```cpp
// –ú–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, –Ω–æ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ
void dynamic_roi(uint8_t* image) {
    // –í—ã—á–∏—Å–ª—è–µ–º ROI –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞
    int y_start = find_first_valid_row(image);
    int y_end = find_last_valid_row(image);
    // ...
}
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º –∫–∞–¥—Ä–µ
- ROI –º–æ–∂–µ—Ç "–ø—Ä—ã–≥–∞—Ç—å" –º–µ–∂–¥—É –∫–∞–¥—Ä–∞–º–∏

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ ROI

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ ROI –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–æ–Ω:

```cpp
// –í–µ—Ä—Ö–Ω—è—è ROI (–¥–∞–ª—å–Ω—è—è –∑–æ–Ω–∞)
const int ROI_FAR_Y_START = 20;
const int ROI_FAR_Y_END = 50;

// –ù–∏–∂–Ω—è—è ROI (–±–ª–∏–∂–Ω—è—è –∑–æ–Ω–∞)
const int ROI_NEAR_Y_START = 70;
const int ROI_NEAR_Y_END = 100;
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–æ–∂–Ω–æ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–æ–Ω—ã
- –õ—É—á—à–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 3: –í–∑–≤–µ—à–µ–Ω–Ω–∞—è ROI

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ—Å–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π:

```cpp
// –¶–µ–Ω—Ç—Ä –≤–∞–∂–Ω–µ–µ –∫—Ä–∞–µ–≤
float weight = 1.0 - abs(x - 80) / 80.0;  // –í–µ—Å –æ—Ç –∫—Ä–∞—è –∫ —Ü–µ–Ω—Ç—Ä—É
```

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Ä–æ–±–æ—Ç–∞ –ú–∏–∫–†–æ–ë–ë–æ–∫—Å:

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é ROI** ‚úÖ
   - –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã: Y[11:102], X[16:144]
   - –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
   - –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞
   - –≠–∫–æ–Ω–æ–º–∏—è 40% –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

2. **–ü—Ä–∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–µ:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å `test_effective_roi.py` —Å –≤–∞—à–∏–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
   - –ü–æ–ª—É—á–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã ROI
   - –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–¥ ESP32

3. **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª–æ–≤–∏–π:**
   - –ü–µ—Ä–µ—Å–Ω—è–ª–∏ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ –∫–∞–¥—Ä—ã? ‚Üí –ü–µ—Ä–µ—Å—á–∏—Ç–∞–π—Ç–µ ROI
   - –ò–∑–º–µ–Ω–∏–ª–æ—Å—å –æ—Å–≤–µ—â–µ–Ω–∏–µ? ‚Üí –ü–µ—Ä–µ—Å—á–∏—Ç–∞–π—Ç–µ ROI
   - –ù–æ–≤–∞—è –∫–∞–º–µ—Ä–∞? ‚Üí –ü–µ—Ä–µ—Å—á–∏—Ç–∞–π—Ç–µ ROI

4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - ROI –ø–æ–∫—Ä—ã–≤–∞–µ—Ç 60.7% ‚Üí —ç–∫–æ–Ω–æ–º–∏—è 40% CPU
   - –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –∫–∞–¥—Ä–æ–≤ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã

---

## ‚úÖ –í—ã–≤–æ–¥—ã

### –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞! ‚úÖ

1. **–§–∏–∑–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —É—á—Ç–µ–Ω—ã:**
   - –ü–µ—Ä–µ—Å–≤–µ—Ç: 0% (–Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º)
   - –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ: 8.21% (–∏—Å–∫–ª—é—á–µ–Ω–æ –∏–∑ ROI)
   - –û—Ç—Ä–∞–∂–µ–Ω–∏–µ LED: –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—á–∏—Ç–∞–Ω–∏–∏
   - –í–∏–Ω—å–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∏—Å–∫–ª—é—á–µ–Ω–æ –∏–∑ ROI

2. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞:**
   - Y: 11-102 (75.8% –≤—ã—Å–æ—Ç—ã)
   - X: 16-144 (80.0% —à–∏—Ä–∏–Ω—ã)
   - –ü–ª–æ—â–∞–¥—å: 60.7% –æ—Ç –æ–±—â–µ–π

3. **–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω:**
   - 80 —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   - 4 —Å—Ü–µ–Ω–∞—Ä–∏—è (–ø—Ä—è–º–∞—è, –≤–ª–µ–≤–æ, –≤–ø—Ä–∞–≤–æ, –æ–∫–æ–Ω—á–∞–Ω–∏–µ)
   - –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã ‚úÖ

4. **–ö–æ–¥ –¥–ª—è ESP32 –≥–æ—Ç–æ–≤:**
   - –ü—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
   - –≠–∫–æ–Ω–æ–º–∏—è 40% –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
   - –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## üìÅ –§–∞–π–ª—ã

```
test/
‚îú‚îÄ‚îÄ test_effective_roi.py              # –°–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏–∑–∞ ROI
‚îú‚îÄ‚îÄ README_EFFECTIVE_ROI.md            # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ output/
    ‚îî‚îÄ‚îÄ roi_analysis_all_scenarios.png # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

data/
‚îú‚îÄ‚îÄ img_straight/  # –ü—Ä—è–º–∞—è –ª–∏–Ω–∏—è (15 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
‚îú‚îÄ‚îÄ img_left/      # –ü–æ–≤–æ—Ä–æ—Ç –≤–ª–µ–≤–æ (16 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
‚îú‚îÄ‚îÄ img_right/     # –ü–æ–≤–æ—Ä–æ—Ç –≤–ø—Ä–∞–≤–æ (16 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
‚îî‚îÄ‚îÄ img_terminate/ # –û–∫–æ–Ω—á–∞–Ω–∏–µ –ª–∏–Ω–∏–∏ (33 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
```

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

- **extract_line_background_subtraction.py** - –±–∞–∑–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–∏
- **extract_line_led_compensation.py** - –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è LED
- **evaluate_frame_differences.py** - –æ—Ü–µ–Ω–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–º–µ—Ä—ã

–í–º–µ—Å—Ç–µ —Å `test_effective_roi.py` –æ–±—Ä–∞–∑—É—é—Ç **–ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–º–µ—Ä–æ–π ESP32CAM —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
