# –®–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
#
# –ó–∞–º–µ–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
# - DEVICE_NAME: –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, robot1, robot2)
# - DEVICE_IP: IP –∞–¥—Ä–µ—Å ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏
# - DOMAIN_NAME: –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, robot1.example.com)
# - API_PORT: –ø–æ—Ä—Ç API ESP32 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 80)
# - STREAM_PORT: –ø–æ—Ä—Ç –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ ESP32 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 81)

# Upstream –¥–ª—è API —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
upstream DEVICE_NAME_api {
    server DEVICE_IP:API_PORT max_fails=3 fail_timeout=30s;
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ keepalive –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    keepalive 32;
}

# Upstream –¥–ª—è –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
upstream DEVICE_NAME_stream {
    server DEVICE_IP:STREAM_PORT max_fails=3 fail_timeout=30s;
    keepalive 16;
}

# HTTP —Å–µ—Ä–≤–µ—Ä - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS
server {
    listen 80;
    server_name DOMAIN_NAME;
    
    # –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # –†–µ–¥–∏—Ä–µ–∫—Ç –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS —Å–µ—Ä–≤–µ—Ä
server {
    listen 443 ssl http2;
    server_name DOMAIN_NAME;

    # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –æ—Ç Let's Encrypt
    ssl_certificate /etc/letsencrypt/live/DOMAIN_NAME/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/DOMAIN_NAME/privkey.pem;
    
    # SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ SSL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;

    # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è WebXR
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Permissions-Policy "accelerometer=*, camera=*, gyroscope=*, magnetometer=*, microphone=*, xr-spatial-tracking=*" always;

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    access_log /var/log/nginx/DEVICE_NAME-access.log;
    error_log /var/log/nginx/DEVICE_NAME-error.log;

    # –û—Å–Ω–æ–≤–Ω–æ–µ API - –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ ESP32
    location / {
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        error_page 502 503 504 = @device_offline;
        
        proxy_pass http://DEVICE_NAME_api;
        
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # –¢–∞–π–º–∞—É—Ç—ã
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ - –º–∞–ø–ø–∏–Ω–≥ —Å –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π URL
    location /stream {
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        error_page 502 503 504 = @stream_offline;
        
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ stream –ø–æ—Ä—Ç ESP32
        proxy_pass http://DEVICE_NAME_stream/;
        
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è streaming
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è live stream
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;
        
        # HTTP/1.1 –¥–ª—è streaming
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è stream
        proxy_connect_timeout 10s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã MJPEG
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API
    location @device_offline {
        default_type text/html;
        return 503 '
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }
                .container {
                    text-align: center;
                    padding: 40px;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 20px;
                    backdrop-filter: blur(10px);
                }
                h1 { font-size: 3em; margin: 0; }
                p { font-size: 1.2em; margin: 20px 0; }
                .device-name { font-weight: bold; color: #ffd700; }
                .retry { margin-top: 30px; }
                button {
                    background: white;
                    color: #667eea;
                    border: none;
                    padding: 15px 30px;
                    font-size: 1.1em;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: transform 0.2s;
                }
                button:hover { transform: scale(1.05); }
            </style>
            <script>
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                setTimeout(function() {
                    location.reload();
                }, 10000);
            </script>
        </head>
        <body>
            <div class="container">
                <h1>ü§ñ ‚ö†Ô∏è</h1>
                <p>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ <span class="device-name">DEVICE_NAME</span> –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</p>
                <p>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</p>
                <ul style="text-align: left; display: inline-block;">
                    <li>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–∫–ª—é—á–µ–Ω–æ</li>
                    <li>–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏</li>
                    <li>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è</li>
                </ul>
                <div class="retry">
                    <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...</p>
                    <button onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>
                </div>
            </div>
        </body>
        </html>
        ';
    }

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞
    location @stream_offline {
        default_type text/html;
        return 503 '
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: #1a1a1a;
                    color: white;
                }
                .container {
                    text-align: center;
                }
                h1 { font-size: 2em; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìπ –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</h1>
                <p>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ DEVICE_NAME –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –≤–∏–¥–µ–æ</p>
            </div>
        </body>
        </html>
        ';
    }

    # Health check endpoint
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
