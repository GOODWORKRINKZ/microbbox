# Настройка роутера Keenetic Viva для MicroRoBox

## Обзор

Роутер Keenetic Viva должен выполнять две ключевые функции:
1. **Локальный DNS сервер** - разрешение доменных имен устройств на IP Raspberry Pi
2. **DHCP резервирование** - присвоение статических IP адресов ESP32 устройствам

## Подготовка роутера

### Проверка версии прошивки

1. Откройте веб-интерфейс роутера: `http://my.keenetic.net` или `http://192.168.1.1`
2. Авторизуйтесь
3. Внизу страницы проверьте версию прошивки
4. Обновите до последней версии если необходимо:
   - **Управление** → **Общие настройки** → **Обновление**

### Установка необходимых компонентов

Keenetic использует модульную систему компонентов. Убедитесь, что установлены:

1. Перейдите: **Управление** → **Общие настройки** → **Изменить набор компонентов**
2. Установите следующие компоненты:
   - ✓ **DNS-прокси** - для локального DNS
   - ✓ **DHCP-сервер** - для резервирования IP (обычно уже установлен)
   - ✓ **Файрвол** - для безопасности (опционально)
3. Нажмите **"Установить"** и дождитесь перезагрузки роутера

## Настройка локального DNS

### Способ 1: Через веб-интерфейс (рекомендуется)

#### Вариант A: Новые прошивки (KeeneticOS 3.x+)

1. Откройте **Управление** → **Общие настройки**
2. Найдите раздел **"Доменные имена"** или **"DNS"**
3. Включите опцию **"Использовать в качестве DNS-прокси"**
4. Перейдите в раздел **"Локальные доменные имена"**
5. Нажмите **"Добавить правило"**
6. Заполните:
   - **Доменное имя**: `robot1.example.com`
   - **IP адрес**: `192.168.1.50` (IP Raspberry Pi)
   - **Описание**: `MicroRoBox Robot 1`
7. Повторите для каждого устройства
8. Сохраните изменения

#### Вариант B: Через файл hosts (альтернатива)

Если прямого интерфейса для DNS нет:

1. Перейдите: **Управление** → **Общие настройки** → **Файлы**
2. Найдите файл `/etc/hosts` или возможность его редактирования
3. Добавьте строки:
   ```
   192.168.1.50  robot1.example.com
   192.168.1.50  robot2.example.com
   192.168.1.50  robot3.example.com
   ```
4. Сохраните и перезагрузите DNS сервис

### Способ 2: Через Telnet/SSH

```bash
# Подключение к роутеру
telnet my.keenetic.net
# или
ssh admin@my.keenetic.net

# Логин и пароль от веб-интерфейса

# Добавление DNS записей
(config)> ip name robot1.example.com 192.168.1.50
(config)> ip name robot2.example.com 192.168.1.50
(config)> ip name robot3.example.com 192.168.1.50

# Просмотр всех записей
(config)> show ip name

# Сохранение конфигурации
(config)> system configuration save

# Выход
(config)> exit
```

### Способ 3: Через мобильное приложение

1. Установите приложение **"Keenetic"** для iOS/Android
2. Подключитесь к роутеру
3. Откройте **Управление сетью** → **DNS**
4. Добавьте локальные DNS записи

## Резервирование IP адресов для ESP32

### Через веб-интерфейс

1. Перейдите: **Домашняя сеть** → **Устройства**
2. Найдите ваше ESP32 устройство:
   - По имени: `MICROBBOX-XXXXXX`
   - По MAC адресу: отображается под именем устройства
   - По текущему IP адресу
3. Кликните на устройство
4. Нажмите кнопку **"Регистрация"** или **"Зарегистрировать"**
5. В открывшемся окне:
   - Включите **"Постоянный IP-адрес"**
   - Введите желаемый IP: `192.168.1.100`
   - Добавьте описание: `Robot 1 - MicroRoBox`
   - Включите **"Постоянная регистрация"** (опционально)
6. Нажмите **"Сохранить"**

### Рекомендуемая схема адресации

```
192.168.1.1   - Роутер Keenetic Viva
192.168.1.50  - Raspberry Pi Zero (nginx proxy)
192.168.1.100 - Robot 1 (ESP32)
192.168.1.101 - Robot 2 (ESP32)
192.168.1.102 - Robot 3 (ESP32)
192.168.1.103 - Robot 4 (ESP32)
192.168.1.104 - Robot 5 (ESP32)
```

### Предварительное резервирование (если устройство еще не подключено)

1. Узнайте MAC адрес ESP32:
   - Посмотрите на наклейку на устройстве
   - Или подключитесь к Serial Monitor (115200 baud) и посмотрите в логах
2. В разделе **Домашняя сеть** → **Устройства** нажмите **"Добавить устройство"**
3. Введите MAC адрес вручную
4. Установите постоянный IP адрес
5. Сохраните

## Настройка проброса портов (Port Forwarding)

Для получения SSL сертификатов Let's Encrypt нужен доступ из интернета:

1. Перейдите: **Интернет-фильтры** → **Переадресация**
2. Нажмите **"Добавить правило"**
3. Для порта 80 (HTTP):
   - **Протокол**: TCP
   - **Внешний порт**: 80
   - **Внутренний IP**: 192.168.1.50 (Raspberry Pi)
   - **Внутренний порт**: 80
   - **Описание**: `Let's Encrypt HTTP Challenge`
4. Для порта 443 (HTTPS):
   - **Протокол**: TCP
   - **Внешний порт**: 443
   - **Внутренний IP**: 192.168.1.50
   - **Внутренний порт**: 443
   - **Описание**: `HTTPS for MicroRoBox`
5. Сохраните правила

**Важно**: После получения SSL сертификатов можно отключить проброс порта 80 для безопасности (оставить только 443).

## Настройка безопасности

### Отключение удаленного доступа к роутеру

1. **Управление** → **Общие настройки** → **Удаленный доступ**
2. Отключите **"Доступ из интернета"**
3. Разрешите доступ только из локальной сети

### Изменение пароля по умолчанию

1. **Управление** → **Пользователи**
2. Выберите пользователя **admin**
3. Нажмите **"Изменить пароль"**
4. Установите сложный пароль

### Настройка гостевой сети (опционально)

Если хотите изолировать роботов в отдельную сеть:

1. **Домашняя сеть** → **Сегменты**
2. Создайте новый сегмент **"Robots"**
3. Настройте отдельную подсеть, например `192.168.2.0/24`
4. Подключите ESP32 устройства к этому сегменту

## Проверка настроек

### Проверка DNS

С любого устройства в локальной сети:

```bash
# Windows
nslookup robot1.example.com

# Linux/macOS
dig robot1.example.com
# или
host robot1.example.com

# Ожидаемый результат:
# Name:    robot1.example.com
# Address: 192.168.1.50
```

### Проверка резервирования IP

1. Перезагрузите ESP32 устройство
2. Проверьте, что оно получило зарезервированный IP:
   - В веб-интерфейсе роутера: **Домашняя сеть** → **Устройства**
   - Или через ping: `ping 192.168.1.100`

### Проверка проброса портов

С устройства вне локальной сети:

```bash
# Проверка доступности порта 80
curl -I http://YOUR_PUBLIC_IP

# Проверка доступности порта 443
curl -I https://YOUR_PUBLIC_IP
```

## Дополнительные возможности Keenetic Viva

### DDNS (Dynamic DNS)

Если у вас динамический внешний IP:

1. **Интернет** → **DDNS**
2. Выберите провайдера (например, DynDNS, No-IP)
3. Введите данные учетной записи
4. Роутер автоматически обновит IP адрес при его изменении

### QoS (Quality of Service)

Для приоритизации трафика видеопотока:

1. **Управление** → **Приоритизация**
2. Создайте правило для приоритизации трафика с IP Raspberry Pi
3. Установите высокий приоритет для портов 80 и 443

### Родительский контроль

Для ограничения доступа роботов к определенным сайтам:

1. **Интернет-фильтры** → **Контент-фильтр**
2. Создайте профиль для устройств роботов
3. Настройте правила фильтрации

## Типичные проблемы и решения

### Проблема: DNS не работает

**Решение:**
1. Убедитесь, что DNS-прокси установлен и включен
2. Проверьте, что устройства используют роутер как DNS сервер:
   - Должен быть `192.168.1.1` в настройках сети
3. Очистите DNS кэш на клиентском устройстве:
   - Windows: `ipconfig /flushdns`
   - macOS: `sudo dscacheutil -flushcache`
   - Linux: `sudo systemd-resolve --flush-caches`

### Проблема: Устройство не получает зарезервированный IP

**Решение:**
1. Проверьте правильность MAC адреса в настройках
2. Убедитесь, что DHCP включен на роутере
3. Перезагрузите устройство
4. Проверьте, что IP не используется другим устройством

### Проблема: Проброс портов не работает

**Решение:**
1. Убедитесь, что внешний IP адрес публичный (не за NAT провайдера)
2. Проверьте правила файрвола роутера
3. Проверьте, что порты не блокируются провайдером
4. Используйте онлайн-сервисы проверки портов

## Альтернативные роутеры

Если у вас другой роутер, основные принципы те же:

### Mikrotik
- Настройка DNS: `/ip dns static add name=robot1.example.com address=192.168.1.50`
- Резервирование IP: `/ip dhcp-server lease add address=192.168.1.100 mac-address=XX:XX:XX:XX:XX:XX`

### OpenWRT/DD-WRT
- Редактирование `/etc/hosts` для DNS
- Статические DHCP leases в `/etc/config/dhcp`

### TP-Link/Asus/D-Link
- Обычно имеют веб-интерфейс для настройки DNS и DHCP резервирования
- Расположение настроек может отличаться, но логика та же

## Дополнительные ресурсы

- [Официальная документация Keenetic](https://help.keenetic.com/hc/ru)
- [Форум Keenetic](https://forum.keenetic.com/)
- [База знаний Keenetic](https://help.keenetic.com/hc/ru/categories/360000247660)

## Заключение

После настройки роутера:
1. Все устройства в локальной сети смогут обращаться к роботам по доменным именам
2. ESP32 устройства будут получать стабильные IP адреса
3. nginx на Raspberry Pi сможет проксировать запросы к устройствам
4. Let's Encrypt сможет получить SSL сертификаты через проброшенный порт 80
